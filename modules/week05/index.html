<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 5: Middleware | MAD9124</title>
    <meta name="description" content="Full-stack: API Development">
    
    
    <link rel="preload" href="/w2025/assets/css/0.styles.09fa0184.css" as="style"><link rel="preload" href="/w2025/assets/js/app.4499714b.js" as="script"><link rel="preload" href="/w2025/assets/js/28.05443665.js" as="script"><link rel="preload" href="/w2025/assets/js/11.326ad447.js" as="script"><link rel="prefetch" href="/w2025/assets/js/10.26ff74d2.js"><link rel="prefetch" href="/w2025/assets/js/12.35bad1be.js"><link rel="prefetch" href="/w2025/assets/js/13.23e02e05.js"><link rel="prefetch" href="/w2025/assets/js/14.35dab012.js"><link rel="prefetch" href="/w2025/assets/js/15.2a251516.js"><link rel="prefetch" href="/w2025/assets/js/16.5bf74ee8.js"><link rel="prefetch" href="/w2025/assets/js/17.f7cb93cc.js"><link rel="prefetch" href="/w2025/assets/js/18.fdbbba40.js"><link rel="prefetch" href="/w2025/assets/js/19.fdb1ccb3.js"><link rel="prefetch" href="/w2025/assets/js/2.27adcba6.js"><link rel="prefetch" href="/w2025/assets/js/20.f9860573.js"><link rel="prefetch" href="/w2025/assets/js/21.e2f87e2d.js"><link rel="prefetch" href="/w2025/assets/js/22.35437b17.js"><link rel="prefetch" href="/w2025/assets/js/23.838a12a8.js"><link rel="prefetch" href="/w2025/assets/js/24.7737eb4b.js"><link rel="prefetch" href="/w2025/assets/js/25.3cf447d7.js"><link rel="prefetch" href="/w2025/assets/js/26.2300627a.js"><link rel="prefetch" href="/w2025/assets/js/27.43e88183.js"><link rel="prefetch" href="/w2025/assets/js/29.e187008c.js"><link rel="prefetch" href="/w2025/assets/js/3.79b67073.js"><link rel="prefetch" href="/w2025/assets/js/30.15712767.js"><link rel="prefetch" href="/w2025/assets/js/31.45d47dfe.js"><link rel="prefetch" href="/w2025/assets/js/32.73113aa5.js"><link rel="prefetch" href="/w2025/assets/js/33.75cc0b00.js"><link rel="prefetch" href="/w2025/assets/js/34.a07b5385.js"><link rel="prefetch" href="/w2025/assets/js/35.10152266.js"><link rel="prefetch" href="/w2025/assets/js/36.a66d25b8.js"><link rel="prefetch" href="/w2025/assets/js/37.f429b2b4.js"><link rel="prefetch" href="/w2025/assets/js/38.72d66438.js"><link rel="prefetch" href="/w2025/assets/js/39.a1f91750.js"><link rel="prefetch" href="/w2025/assets/js/4.775a0ac5.js"><link rel="prefetch" href="/w2025/assets/js/5.85d5fdc4.js"><link rel="prefetch" href="/w2025/assets/js/6.7163030f.js"><link rel="prefetch" href="/w2025/assets/js/7.30435e52.js"><link rel="prefetch" href="/w2025/assets/js/8.f5e07bc6.js"><link rel="prefetch" href="/w2025/assets/js/9.7ecaa892.js">
    <link rel="stylesheet" href="/w2025/assets/css/0.styles.09fa0184.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/w2025/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/w2025/overview/" class="nav-link">Overview</a></div><div class="nav-item"><a href="/w2025/modules/" class="nav-link router-link-active">Modules</a></div><div class="nav-item"><a href="/w2025/deliverables/" class="nav-link">Deliverables</a></div><div class="nav-item"><a href="/w2025/resources/" class="nav-link">Resources</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/w2025/overview/" class="nav-link">Overview</a></div><div class="nav-item"><a href="/w2025/modules/" class="nav-link router-link-active">Modules</a></div><div class="nav-item"><a href="/w2025/deliverables/" class="nav-link">Deliverables</a></div><div class="nav-item"><a href="/w2025/resources/" class="nav-link">Resources</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/w2025/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/w2025/modules/week01/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/w2025/modules/week02/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/w2025/modules/week03/" class="sidebar-link">Week 3: APIs</a></li><li><a href="/w2025/modules/week04/" class="sidebar-link">Week 4: Project Structure, RESTful alternatives, and Postman</a></li><li><a href="/w2025/modules/week05/" aria-current="page" class="active sidebar-link">Week 5: Middleware</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#making-the-developer-experience-better" class="sidebar-link">Making the developer experience better</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#nodemon" class="sidebar-link">Nodemon</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#scripts" class="sidebar-link">Scripts</a></li></ul></li><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#middleware" class="sidebar-link">Middleware</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#what-is-middleware" class="sidebar-link">What is middleware</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#types-of-middleware" class="sidebar-link">Types of middleware</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#common-use-cases" class="sidebar-link">Common use cases</a></li></ul></li><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#logging" class="sidebar-link">Logging</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#router-modules" class="sidebar-link">Router Modules</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#validation" class="sidebar-link">Validation</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#error-handling" class="sidebar-link">Error Handling</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#exercise-5" class="sidebar-link">Exercise 5</a></li><li class="sidebar-sub-header"><a href="/w2025/modules/week05/#more-resources" class="sidebar-link">More resources</a></li></ul></li><li><a href="/w2025/modules/week06/" class="sidebar-link">Week 6: API Integration &amp; Caching</a></li><li><a href="/w2025/modules/week07/" class="sidebar-link">Week 7: Midterm Project</a></li><li><a href="/w2025/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/w2025/modules/week09/" class="sidebar-link">Week 9: Data Persitance and MongoDB</a></li><li><a href="/w2025/modules/week10/" class="sidebar-link">Week 10: Object Data Modelling with Mongoose</a></li><li><a href="/w2025/modules/week11/" class="sidebar-link">Week 11: Data Santization, XSS and LoggingS</a></li><li><a href="/w2025/modules/week12/" class="sidebar-link">Week 12: Authentication With Passport</a></li><li><a href="/w2025/modules/week13/" class="sidebar-link">Week 13: Testing with Jest</a></li><li><a href="/w2025/modules/week14/" class="sidebar-link">Week 14: Preparing for Production</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1><span class="week">Week 5</span><br> <span class="title">Middleware</span></h1> <ul><li>AMA (15 min)</li> <li>Making the dev experience better</li> <li>What is middleware
<ul><li>Types of middleware</li> <li>Common use cases</li></ul></li> <li>Logging</li> <li>Router modules</li> <li>Validation</li> <li>Error Handling</li> <li>Exercise</li> <li>More resources</li></ul> <h2 id="making-the-developer-experience-better"><a href="#making-the-developer-experience-better" class="header-anchor">#</a> Making the developer experience better</h2> <p>Are you tired of constantly killing and restarting your server? Let's make our life easier with nodemon and scripts.</p> <h3 id="nodemon"><a href="#nodemon" class="header-anchor">#</a> Nodemon</h3> <p>First, let's install a new dependency called <code>nodemon</code>. This package watches our codebase, and if any changes are made, it tells node to restart the server automatically!</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i --save-dev nodemon
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">Dev Dependencies</p> <p>There are some packages that we only need for development. Marking them as dev dependencies allows our production build to be lighter, as it will exclude the dependencies it doesn't need to run!</p></div> <h3 id="scripts"><a href="#scripts" class="header-anchor">#</a> Scripts</h3> <p>We can add custom scripts to <code>package.json</code>. These are common commands we will use with our application, and it saves having to type it out every time! Add the following to your package.json file.</p> <div class="language-json extra-class"><pre class="language-json"><code>...
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon src/index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node src/index.js&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>Now, simply run <code>npm run dev</code>, or <code>npm run start</code>, and see our application start up as expected.</p> <h2 id="middleware"><a href="#middleware" class="header-anchor">#</a> Middleware</h2> <h3 id="what-is-middleware"><a href="#what-is-middleware" class="header-anchor">#</a> What is middleware</h3> <p>Middleware functions are used to encapsulate functionality that you want to apply to multiple routes without repeating the code in every route handler. They run before the route handlers are evaluated and may be chained together. Each middleware function can either end the request or pass control to the next function in the pipeline, until the final route handler is reached.</p> <p>Middleware in ExpressJS and Node.js is a powerful feature that allows you to manipulate the incoming request and outgoing response in your application. It acts as an intermediary between the request and response, allowing you to perform tasks such as authentication, logging, and data validation.</p> <p>In ExpressJS, middleware functions are added to the middleware stack using the <code>app.use</code> method. These functions take three arguments: <code>req</code>, <code>res</code>, and <code>next</code>. The <code>req</code> argument is the incoming request object, the <code>res</code> argument is the outgoing response object, and the <code>next</code> argument is a function that is called to move to the <code>next</code> middleware function in the stack.</p> <h3 id="types-of-middleware"><a href="#types-of-middleware" class="header-anchor">#</a> Types of middleware</h3> <p>An Express application can use the following types of middleware:</p> <ul><li>Application-level middleware</li> <li>Router-level middleware</li> <li>Error-handling middleware
<ul><li>different function signature</li></ul></li> <li>Built-in middleware
<ul><li>express.json()</li> <li>express.urlencoded()</li> <li>express.static</li></ul></li> <li>Third-party middleware
<ul><li><a href="npmjs.com/search?q=express%20middleware">over 5000 packages on NPM</a></li></ul></li></ul> <h3 id="common-use-cases"><a href="#common-use-cases" class="header-anchor">#</a> Common use cases</h3> <ul><li>router modules</li> <li>validation</li> <li>error handling</li> <li>enforcing security best practices</li></ul> <h2 id="logging"><a href="#logging" class="header-anchor">#</a> Logging</h2> <p>Let's create a simple middleware function that logs information about the incoming request. To do this, we'll use the <code>console.log</code> method to log the request method, path, and date and time of the request.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">logMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> request made to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>logMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We can then use this middleware function in our application by adding it to the middleware stack using the app.use method. This will ensure that the function is called for every incoming request.</p> <h2 id="router-modules"><a href="#router-modules" class="header-anchor">#</a> Router Modules</h2> <p>Middleware refers to the functions that are executed before a request reaches the route handler. These functions can perform tasks such as logging, authentication, and data validation. They are added to the middleware stack using the app.use method in ExpressJS and are executed in the order they are added.</p> <p>Routes refer to the endpoints in your application that handle incoming HTTP requests. They are defined using the methods on the ExpressJS app object, such as app.get, app.post, app.put, and app.delete. The route handler is a function that is executed when a matching request is received.</p> <p>Here is an example of how middleware and routes can work together in an ExpressJS application:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a middleware function that logs the incoming request</span>
<span class="token keyword">const</span> <span class="token function-variable function">logMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> request made to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Use the log middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>logMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a route that returns &quot;Hello World&quot;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start the server</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">4000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Server started on port 4000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In this example, we define a middleware function that logs the incoming request, and use it in our application using the <code>app.use</code> method. We also define a simple route that returns &quot;Hello World&quot;.</p> <p>When a request is made to the &quot;/&quot; endpoint, the logMiddleware function will be executed first, logging the incoming request to the console. The request will then be passed to the route handler, which will return &quot;Hello World&quot; as the response.</p> <p>This is just a simple example of how middleware and routes can work together in an ExpressJS and Node.js application. In a real-world application, you would likely have more complex middleware functions and routes, and may also use additional libraries such as Mongoose for data storage.</p> <h2 id="validation"><a href="#validation" class="header-anchor">#</a> Validation</h2> <p>Validation is an important aspect of building a robust and secure web application in ExpressJS and Node.js. It ensures that incoming data from the client is valid before processing it further.</p> <p>Here's an example of how to use middleware for data validation in ExpressJS:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">validateMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> make<span class="token punctuation">,</span> model<span class="token punctuation">,</span> colour <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>make <span class="token operator">||</span> <span class="token operator">!</span>model <span class="token operator">||</span> <span class="token operator">!</span>colour<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">&quot;Invalid car data&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/cars&quot;</span><span class="token punctuation">,</span> validateMiddleware<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Add the new carr to the database or in an array</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In this example, we use destructuring to extract the <code>make</code>, <code>model</code> and <code>colour</code> properties from the <code>req.body</code> object. We then check if these properties are present and return a <code>400 Bad Request</code> response if they are not. If the properties are present, the function calls <code>next</code> to move to the next middleware function in the stack or to the route handler if there are no more middleware functions.</p> <p>It's also possible to use external libraries, such as <a href="https://joi.dev/" target="_blank" rel="noopener noreferrer">Joi<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or <a href="https://express-validator.github.io/docs/" target="_blank" rel="noopener noreferrer">Express Validator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, for more complex validation logic. These libraries provide a convenient way to write validation rules and return informative error messages in case of validation failure.</p> <p>Middleware validation is a crucial aspect of building a secure and reliable web application. It helps ensure that incoming data from the client is valid before processing it further, and helps prevent security issues and unexpected behavior in the application.</p> <h2 id="error-handling"><a href="#error-handling" class="header-anchor">#</a> Error Handling</h2> <p>Express has a special middleware function for handling errors. This function takes 4 arguments: <code>error</code>, <code>request</code>, <code>response</code> and <code>next</code>, and is typically last in the list of request handlers, just be app.listen. This can be used to catch any error thrown in our application, and send back a correctly formatted error response, all from one place!</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> _req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> _next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Log the error for debugging</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message <span class="token operator">??</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;Something went wrong&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now, any error thrown in a non asynchronous function, or any error passed to next will be sent to our error handler. Let's try a fake middleware function that will throw an error if a query parameter is missing.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">middlewareFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> _res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>test<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Expected test in the query parameters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> middlewareFn<span class="token punctuation">;</span>
</code></pre></div><p>This is great, because it sends back our formatted error, however, it is too generic, and always status 500. Let's create or own custom error class that extends <code>Error</code>, so we can pass along the status code to our error handler.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">ServerError</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
  status <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">BadRequestError</span> <span class="token keyword">extends</span> <span class="token class-name">ServerError</span> <span class="token punctuation">{</span>
  status <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">UnauthorizedError</span> <span class="token keyword">extends</span> <span class="token class-name">ServerError</span> <span class="token punctuation">{</span>
  status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ForbiddenError</span> <span class="token keyword">extends</span> <span class="token class-name">ServerError</span> <span class="token punctuation">{</span>
  status <span class="token operator">=</span> <span class="token number">403</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">NotFoundError</span> <span class="token keyword">extends</span> <span class="token class-name">ServerError</span> <span class="token punctuation">{</span>
  status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  ServerError<span class="token punctuation">,</span>
  BadRequestError<span class="token punctuation">,</span>
  UnauthorizedError<span class="token punctuation">,</span>
  ForbiddenError<span class="token punctuation">,</span>
  NotFoundError<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Because all of our custom errors have are instances of ServerError, we can use this to validate that an incoming error is one of our custom errors with a status. We can then respond with the correct status and message!</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> _req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> _next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message <span class="token operator">??</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">ServerError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;Something went wrong&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">Don't display unknown error messages</p> <p>We will be throwing our custom errors from now on, and we will be intentional about the error messages we write. We cannot trust unknown errors to not have sensitive data that we a user may not need to know about. This is why we sent <code>Something went wrong</code> as the default message for unknown errors.</p></div> <p>We can modify our test middleware function to use our custom errors to pass along the status:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> BadRequestError <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./middleware/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">middlewareFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> _res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>test<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BadRequestError</span><span class="token punctuation">(</span><span class="token string">&quot;Expected test in the query parameters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> middlewareFn<span class="token punctuation">;</span>
</code></pre></div><p>Great! The final thing to do is update our controller functions to have a next parameter, and pass the error from our try catch block to next. For example in our cars api, we update our cars controller like so:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/controllers/cars.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// passing the error to next here, and it will end up at our error handler!</span>
        <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This allows us to move the business logic out of the controller, and into its own service file. We can throw our custom errors in this service file, and express will automatically respond with the correctly formatted error.</p> <p>This can simplify our code, and separate the concerns. Splitting up the work as follows:</p> <ul><li>Controller:
<ul><li>gets information from the request</li> <li>responds with the results</li> <li>sends any errors to the error handler</li></ul></li> <li>Service:
<ul><li>performs the business logic</li> <li>connects with the Model</li> <li>can be reused without having to worry about request / responses</li></ul></li></ul> <p><em>Refactor done in class - see the in-class-repo</em></p> <h2 id="exercise-5"><a href="#exercise-5" class="header-anchor">#</a> Exercise 5</h2> <ul><li>Create a new project in your mad9124 repo (<code>/week05/exercise</code>) and install the dependencies.</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>  <span class="token function">npm</span> init
  <span class="token function">npm</span> i express
  <span class="token function">npm</span> i --save-dev nodemon
</code></pre></div><ul><li>Add your <code>start</code> and <code>dev</code> scripts to package.json:</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// package.json</span>
  ...
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon src/index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node src/index.js&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Create the src/index.js file and add the express app basics.</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> userRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routers/user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Application level middleware here</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Routes here</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Server Running..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/api/user&quot;</span><span class="token punctuation">,</span> userRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">4000</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">App listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>Create a new middleware function that will validate the incoming user data. This function should check if the <code>name</code> and <code>email</code> properties are present in the <code>req.body</code> object. If either of these properties is missing, return a <code>400 Bad Request</code> response with a message <code>&quot;Name and email are required&quot;</code>.</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/middleware/validateUserData.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">validateUserData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// your code here</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> validateUserData<span class="token punctuation">;</span>
</code></pre></div><ul><li>Create 2 routes.
<ul><li>1 for getting all users from an in-memory array.</li> <li>1 for adding (Post request) a user. This route should use the validation middleware created in step 2 and add the user to an in-memory database (an array). If the validation passes, return a <code>201 Created</code> response with the newly created user object.</li></ul></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// src/routes/user.js</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> Router <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> userRouter <span class="token operator">=</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  userRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span>
  userRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>Use the correct project structure + error handling</li> <li>Make sure to import and export correctly to and from each module</li> <li>Start the Express server and test the user creation route using a Postman.</li> <li>Once you are confident it is running as expected, commit your changes, push to github, and submit with a link to your github repo in Brightspace!</li></ul> <h2 id="more-resources"><a href="#more-resources" class="header-anchor">#</a> More resources</h2> <ul><li><a href="https://expressjs.com/en/guide/writing-middleware.html" target="_blank" rel="noopener noreferrer">Writing middleware for use in Express apps<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://youtu.be/MIr1oxQ3pao" target="_blank" rel="noopener noreferrer">Express JS - What the Heck is Middleware<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://expressjs.com/en/4x/api.html#router" target="_blank" rel="noopener noreferrer">Router<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://youtu.be/iM_S4RczozU" target="_blank" rel="noopener noreferrer">Express JS - Roueer and Routes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2/2/2025, 2:43:13 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/w2025/modules/week04/" class="prev">
          Week 4: Project Structure, RESTful alternatives, and Postman
        </a></span> <span class="next"><a href="/w2025/modules/week06/">
          Week 6: API Integration &amp; Caching
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/w2025/assets/js/app.4499714b.js" defer></script><script src="/w2025/assets/js/28.05443665.js" defer></script><script src="/w2025/assets/js/11.326ad447.js" defer></script>
  </body>
</html>
